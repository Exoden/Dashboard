{% extends "IdleBundle:Default:index.html.twig" %}

{% block title %}{{ parent() }}Homepage{% endblock %}

{% block header %}
    <div class="row">
        <div class="col-md-12">
            <h1>Idle HomePage</h1>
        </div>
    </div>
{% endblock %}

{% block page %}
    <div class="row">
        {{ include('AppBundle::flash_messages.html.twig') }}
        <div class="col-md-6 out-menu">
            <div class="col-md-12 menu">
                <div class="row">
                    0 <img src="{{ asset('images/Idle/Icon/soul.png') }}" title="Souls">
                </div>
                {% for key, hero in heroes %}
                    <div id="hero_{{ key }}" class="row details-hero {#{% if hero.isSelected == true %}selected{% endif %}#}">
                        <div class="col-md-4 character" data-value="{{ hero.id }}">
                            {#<span title="{{ hero.name }}" data-toggle="popover" data-placement="top" data-trigger="hover" data-content="#}
                                    {#Age: {{ hero.age }}<br />#}
                                    {#Level: {{ hero.level }}<br />#}
                                    {#Experience: {{ hero.experience }}<br />#}
                                    {#State: {% if hero.isRested %}OK{% else %}KO{% endif %}">#}
                            <img src="{{ asset('images/Idle/Character/HumanF.png') }}" alt="hero" class="hero">
                            {#</span>#}
                            <h2 class="damage"></h2>
                        </div>
                        <div class="col-md-8">
                            <div class="row top">
                                <div class="col-md-3">
                                    <p>
                                        {{ hero.name }} ({{ hero.age }})
                                        {# TODO : Barre d'hp #}
                                        {# TODO : Icone etat #}
                                        {#{% if hero.isRested %}OK{% else %}KO{% endif %}#}
                                        <img src="{{ asset('images/Idle/Icon/state_good.png') }}">
                                        <img src="{{ asset('images/Idle/Icon/state_bad.png') }}">
                                        <img src="{{ asset('images/Idle/Icon/state_rest.png') }}">
                                        <img src="{{ asset('images/Idle/Icon/state_poison.png') }}">
                                        {#Level: {{ hero.level }}#}
                                        {#Experience: {{ hero.experience }}#}
                                        {#State: {% if hero.isRested %}OK{% else %}KO{% endif %}#}
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <div class="progress progress-hp" title="HP : {{ hero.currentHealth }}/{{ hero.characteristics.health }}">
                                        <div class="progress-bar-hp" role="progressbar" data-value="{{ hero.currentHealth }}" style="width: {{ (hero.currentHealth / hero.characteristics.health) * 100 }}%"></div>
                                    </div>
                                </div>
                                <div class="col-md-3" style="text-align: right">
                                    <a class="btn btn-default btn-circle potions" data-value="{{ hero.id }}" title="Potions"><img src="{{ asset('images/Idle/Icon/potion.png') }}"></a>
                                    <a class="btn btn-default btn-circle skill_tree" data-value="{{ hero.id }}" title="Skills"><img src="{{ asset('images/Idle/Icon/skills.png') }}"></a>
                                </div>
                            </div>
                            <div class="row one">
                                {% for type, equipment in equipments[key]|slice(0, 3) %}
                                    <span title="{% if equipment is not null %}{{ equipment.item.name }}{% endif %}"
                                         data-toggle="popover" data-placement="top" data-trigger="hover"
                                         data-content="{% if equipment is not null %}{% include 'IdleBundle:Default:popover_equipment.html.twig' with {'stuff': equipment} %}{% endif %}">
                                        <img class="bordered" src="{% if equipment is not null %}{{ asset('images/Idle/' ~ equipment.item.typeItem.name ~ '/' ~ equipment.item.image) }}{% endif %}" alt="{{ type|lower }}">
                                    </span>
                                {% endfor %}
                            </div>
                            <div class="row two">
                                {% for type, equipment in equipments[key]|slice(3) %}
                                    <span title="{% if equipment is not null %}{{ equipment.item.name }}{% endif %}"
                                          data-toggle="popover" data-placement="top" data-trigger="hover"
                                          data-content="{% if equipment is not null %}{% include 'IdleBundle:Default:popover_equipment.html.twig' with {'stuff': equipment} %}{% endif %}">
                                        <img class="bordered" src="{% if equipment is not null %}{{ asset('images/Idle/' ~ equipment.item.typeItem.name ~ '/' ~ equipment.item.image) }}{% endif %}" alt="{{ type|lower }}">
                                    </span>
                                {% endfor %}
                            </div>
                            <div class="row bottom">
                                <div class="col-md-3">
                                    {#<p class="level">Level: {{ hero.level }}</p>#}
                                        {# TODO : Barre d'xp #}
                                        {#HP: {{ hero.characteristics.health }}#}
                                        {#Armor:  {{ hero.characteristics.armor }}#}
                                        {#Dodge: {{ hero.characteristics.dodge }}#}
                                        {#Attack: {{ hero.characteristics.damageMinimum }}-{{ hero.characteristics.damageMaximum }}#}
                                        {#Delay: {{ hero.characteristics.attackDelay }}#}
                                        {#Precision: {{ hero.characteristics.hitPrecision }}#}
                                </div>
                                {#<div class="col-md-9 progress progress-exp" title="Exp. : {{ hero.experience }}/{{ next_level[key] }}">#}
                                    {#<div class="progress-bar-exp" role="progressbar" data-value="{{ hero.experience }}" style="width: {{ (hero.experience / next_level[key]) * 100 }}%"></div>#}
                                {#</div>#}
                            </div>
                        </div>
                    </div>
                {% endfor %}
                {% if canCreateHero %}
                    <a class="btn" id="create_hero" title="Create a new Hero"><img src="{{ asset('images/plus.png') }}"></a> {# data-toggle="modal" data-target="#myModal" #}
                {% endif %}
            </div>
        </div>


        <div class="col-md-6 out-menu">
            <div class="col-md-12 menu">
                {% for key, hero in heroes %}
                    <div id="mob_{{ key }}" class="row details-mob">
                        <div class="col-md-4 character">
                            <img src="{{ asset('images/Idle/Enemy/' ~ hero.target.enemy.image) }}" alt="monster" class="monster">
                            <h2 class="damage"></h2>
                        </div>
                        <div class="col-md-8">
                            <div class="row top">
                                <div class="row" style="text-align: center">
                                    {# TODO : buttons Ajax => change area, regenerate battleHistory #}
                                    <div class="btn-group" role="group">
                                        {% for zone in hero.zones %}
                                            <a class="btn btn-default btn-xs{% if zone.activated %} active{% endif %}"><img src="{{ asset('images/Idle/Icon/' ~ zone.area.name|lower ~ '.png') }}" title="{{ zone.area.name }}"></a>
                                        {% endfor %}
                                        {#<a href="#" class="btn btn-default btn-xs{% if hero.zone.area.name == "Forest" %} active{% endif %}"><img src="{{ asset('images/Idle/Icon/forest.png') }}" title="Forest"></a>#}
                                        {#<a href="#" class="btn btn-default btn-xs{% if hero.zone.area.name == "Mountain" %} active{% endif %}"><img src="{{ asset('images/Idle/Icon/mountain.png') }}" title="Mountain"></a>#}
                                        {#<a href="#" class="btn btn-default btn-xs{% if hero.zone.area.name == "Volcano" %} active{% endif %}"><img src="{{ asset('images/Idle/Icon/volcano.png') }}" title="Volcano"></a>#}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-9">
                                        <p>Field {{ hero.getActivatedZone.currentField }}</p>
                                    </div>
                                    <div class="col-md-3">
                                        <p>Field Max {{ hero.getActivatedZone.maxField }}</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <p class="name">{{ hero.target.enemy.name }}</p>
                                </div>
                                <div class="col-md-9 progress progress-hp" title="HP : {{ hero.target.currentHealth }}/{{ hero.target.enemy.characteristics.health }}">
                                    <div class="progress-bar-hp" role="progressbar" data-value="{{ hero.target.currentHealth }}" style="width: {{ ( hero.target.currentHealth * 100) / hero.target.enemy.characteristics.health }}%"></div>
                                </div>
                            </div>
                            <div class="row bottom">
                                <div class="col-md-3">
                                    <img src="{{ asset('images/Idle/Icon/health.png') }}" title="Health"> <span class="current_health">{{ hero.target.currentHealth }}</span> / <span class="max_health">{{ hero.target.enemy.characteristics.health }}</span>
                                </div>
                                <div class="col-md-3">
                                    <img src="{{ asset('images/Idle/Icon/armor.png') }}" title="Armor"> <span class="armor">{{ hero.target.enemy.characteristics.armor }}</span>
                                </div>
                                <div class="col-md-3">
                                    <img src="{{ asset('images/Idle/Icon/dodge.png') }}" title="Dodge"> <span class="dodge">{{ hero.target.enemy.characteristics.dodge }}</span>%
                                </div>
                                <div class="col-md-3">
                                    <img src="{{ asset('images/Idle/Icon/attack_delay.png') }}" title="Attack Delay"> <span class="attack_delay">{{ hero.target.enemy.characteristics.attackDelay }}</span> sec
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="modal fade" id="my_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"></div>
{% endblock %}

{% block javascripts %}
<script>
    $(document).ready(function(){
        $('[data-toggle="popover"]').popover({
            html:true
        });

//        $('a[rel=popover-img]').popover({
//            html: true,
//            trigger: 'hover',
//            placement: 'top',
//            content: function() { return '<img src="' + $(this).data('img') + '" />'; }
//        });


        {#$('.potions').click(function () {#}
            {#var url = '{{ path("hero_skill_tree", {'hero_id': 'HERO_ID'}) }}';#}
            {#url = url.replace("HERO_ID", $(this).data('value'));#}
            {#console.log(url);#}

            {#$.ajax({#}
                {#method: "POST",#}
                {#url: url#}
            {#})#}
                {#.done(function (data) {#}
                    {#$('#my_modal').html(data).modal();#}

                    {#$('#modal_submit').submit(function () {#}
                        {#console.log('submit');#}
                        {#$.ajax({#}
                            {#method: "POST",#}
                            {#url: url#}
                        {#})#}
                    {#});#}
                {#});#}
        {#});#}

        $('.skill_tree').click(function () {
            var url = '{{ path("hero_skill_tree", {'hero_id': 'HERO_ID'}) }}';
            url = url.replace("HERO_ID", $(this).data('value'));
            console.log(url);

            $.ajax({
                method: "POST",
                url: url
            })
                .done(function (data) {
                    $('#my_modal').html(data).modal();

                    $('#modal_submit').submit(function () {
                        console.log('submit');
                        $.ajax({
                            method: "POST",
                            url: url
                        })
                    });
                });
        });

        $('#create_hero').click(function () {
            var url = '{{ path("create_hero") }}';
            console.log(url);

            $.ajax({
                method: "POST",
                url: url
            })
                .done(function (data) {
                    $('#my_modal').html(data.html).modal();

                    $('#modal_submit').submit(function () {
                        console.log('submit');
                        $.ajax({
                            method: "POST",
                            url: url
                        })
                    });
                });
        });
    });

    {% for key, hero in heroes %}
        getBattleHistory({{ key }});
    {% endfor %}

    function getBattleHistory(id)
    {
        var url = '{{ path("battle_history", {'hero_id': 'HERO_ID'}) }}';
        url = url.replace("HERO_ID", $('#hero_' + id).children('.character').data('value'));
        console.log(url);

//        $.ajax({
//            method: "POST",
//            url: url
//        })
//            .done(function (data) {
//                console.log('done');
//                var obj = data;
//                if (obj.success) {
//                    console.log('success');
//                    if ((obj.battle_history[0].time * 1000) <= (new Date()).getTime()) {
//                        animateBattle(obj.battle_history, id);
//                    }
//                    else {
//                        setTimeout(function () {
//                            animateBattle(obj.battle_history, id);
//                        }, Math.floor(obj.battle_history[0].time * 1000) - (new Date()).getTime());
//                    }
//                }
//            })
    }

    function animateBattle(bh, id) {
        console.log("length : " + bh.length);

        console.log("- " + bh[0].time * 1000 + ": " + bh[0].damage + ": " + bh[0].currentHealth + "/" + bh[0].health);

        var t = (new Date()).getTime();
        var progress_bar_mob = $('#mob_' + id + ' .progress-bar-hp');
        var progress_bar_hero = $('#hero_' + id + ' .progress-bar-hp');

        if (bh[0].type == "HIT_E") { // Attack Enemy
            console.log('HIT_E');

            progress_bar_mob.data('value', bh[0].currentHealth);
            $('#mob_' + id + ' .current_health').text(bh[0].currentHealth);

            progress_bar_mob.animate({width: ((bh[0].currentHealth * 100) / bh[0].health) + '%'}, 200);
            $('#mob_' + id + ' .progress-hp').attr('title', "HP : " + bh[0].currentHealth + "/" + bh[0].health);
            $('#mob_' + id + ' .damage')
                .html(bh[0].damage)
                .removeAttr('style')
                .animate({opacity: 0, top: "-=100px"}, 1000);
            {#if (bh[0].currentHealth <= 0) {#}
                {# TODO : animate fadein img without border #}
                {#$('#mob_' + id + ' img').animate({opacity: 0}, 1000);#}
            {#}#}
        }
        else if (bh[0].type == "HIT_H") { // Attack Hero
            console.log('HIT_H');

            progress_bar_hero.data('value', bh[0].currentHealth);

            progress_bar_hero.animate({width: ((bh[0].currentHealth * 100) / bh[0].health) + '%'}, 200);
            $('#hero_' + id + ' .progress-hp').attr('title', "HP : " + bh[0].currentHealth + "/" + bh[0].health);
            $('#hero_' + id + ' .damage')
                .html(bh[0].damage)
                .removeAttr('style')
                .animate({opacity: 0, top: "-=100px"}, 1000);
        }
        else if (bh[0].type == "GEN") { // Generate Enemy
            console.log('GEN');

            $('#mob_' + id + ' img.monster').attr('src', bh[0].image);
//            $('#mob_' + id + ' img').css('opacity', 100);
            progress_bar_mob.data('value', bh[0].currentHealth);
            progress_bar_mob.animate({width: '100%'}, 200);
            $('#mob_' + id + ' .current_health').text(bh[0].currentHealth);
            $('#mob_' + id + ' .max_health').text(bh[0].stats.health);
            $('#mob_' + id + ' .armor').text(bh[0].stats.armor);
            $('#mob_' + id + ' .dodge').text(bh[0].stats.dodge);
            $('#mob_' + id + ' .attack_delay').text(bh[0].stats.attackDelay);

            if (typeof (bh[0].loot_msg) !== 'undefined')
                $('#flash-messages').flashNotification('addSuccess', bh[0].loot_msg);
        }

//                console.log('next call : ' + ((bh[1].time * 1000) - (new Date()).getTime()));
        if ((bh[1].time * 1000) <= (new Date()).getTime()) { // if next time is already passed, play it now
            animateBattle(bh.slice(1), id);
        }
        else {
            window.setTimeout(function () {
                animateBattle(bh.slice(1), id); // we slice to the next elemet
            }, Math.floor(bh[1].time * 1000) - t);
            return false;
        }
    }
</script>
{% endblock %}